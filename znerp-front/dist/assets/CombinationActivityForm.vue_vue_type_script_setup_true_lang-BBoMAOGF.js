import{e as T,D as U,d as B,h as O,z as q,r,o as V,c as K,f as n,w as u,a as i,x as P,y as j,q as H,k as J,F as Q,aw as W,aB as Y,aC as X,I as Z,cc as $,K as ee,M as ae,aA as oe}from"./index-CIfmhqRC.js";import{_ as te}from"./Dialog.vue_vue_type_style_index_0_lang-CtaLqQeX.js";import{_ as se}from"./Form-cSLPXDG2.js";import{g as ie,c as le,u as re}from"./combinationActivity-DUAmepQB.js";import{b as M}from"./formatTime-DFFN_xWx.js";import{r as c}from"./formRules-C3y0LKNH.js";import{u as ne}from"./useCrudSchemas-BA8R3pf3.js";import{_ as ue}from"./SpuSelect.vue_vue_type_script_setup_true_lang-CJLQ12oD.js";import{_ as ce}from"./SpuAndSkuList.vue_vue_type_script_setup_true_lang-DI30tUg0.js";import{g as me}from"./index-BRD6A8QB.js";import{b as pe}from"./spu-BTu6kAbO.js";const de=T({name:[c],totalLimitCount:[c],singleLimitCount:[c],startTime:[c],endTime:[c],userSize:[c],limitDuration:[c],virtualGroup:[c]}),fe=T([{label:"\u62FC\u56E2\u540D\u79F0",field:"name",isSearch:!0,isTable:!1,form:{colProps:{span:24}}},{label:"\u6D3B\u52A8\u5F00\u59CB\u65F6\u95F4",field:"startTime",formatter:M,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u6D3B\u52A8\u7ED3\u675F\u65F6\u95F4",field:"endTime",formatter:M,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u53C2\u4E0E\u4EBA\u6570",field:"userSize",isSearch:!1,form:{component:"InputNumber",labelMessage:"\u53C2\u4E0E\u4EBA\u6570\u4E0D\u80FD\u5C11\u4E8E\u4E24\u4EBA",value:2}},{label:"\u9650\u5236\u65F6\u957F",field:"limitDuration",isSearch:!1,isTable:!1,form:{component:"InputNumber",labelMessage:"\u9650\u5236\u65F6\u957F(\u5C0F\u65F6)",componentProps:{placeholder:"\u8BF7\u8F93\u5165\u9650\u5236\u65F6\u957F(\u5C0F\u65F6)"}}},{label:"\u603B\u9650\u8D2D\u6570\u91CF",field:"totalLimitCount",isSearch:!1,isTable:!1,form:{component:"InputNumber",value:0}},{label:"\u5355\u6B21\u9650\u8D2D\u6570\u91CF",field:"singleLimitCount",isSearch:!1,isTable:!1,form:{component:"InputNumber",value:0}},{label:"\u865A\u62DF\u6210\u56E2",field:"virtualGroup",dictType:U.INFRA_BOOLEAN_STRING,dictClass:"boolean",isSearch:!0,form:{component:"Radio",value:!1}},{label:"\u62FC\u56E2\u5546\u54C1",field:"spuId",isSearch:!1,form:{colProps:{span:24}}}]),{allSchemas:be}=ne(fe),ve=B({name:"PromotionCombinationActivityForm",__name:"CombinationActivityForm",emits:["success"],setup(he,{expose:R,emit:x}){const{t:S}=O(),_=q(),p=r(!1),C=r(""),d=r(!1),w=r(""),m=r(),I=r(),D=r(),h=r([]),k=r([]),L=[{name:"productConfig.combinationPrice",rule:o=>o>=.01,message:"\u5546\u54C1\u62FC\u56E2\u4EF7\u683C\u4E0D\u80FD\u5C0F\u4E8E0.01 \uFF01\uFF01\uFF01"}],N=(o,e)=>{m.value.setValues({spuId:o}),F(o,e)},F=async(o,e,t)=>{var y;const l=[],f=await pe([o]);if(f.length==0)return;h.value=[];const a=f[0],b=e===void 0?a==null?void 0:a.skus:(y=a==null?void 0:a.skus)==null?void 0:y.filter(s=>e.includes(s.id));b==null||b.forEach(s=>{let v={spuId:a.id,skuId:s.id,combinationPrice:0};if(t!==void 0){const g=t.find(G=>G.skuId===s.id);g&&(g.combinationPrice=oe(g.combinationPrice)),v=g||v}s.productConfig=v}),a.skus=b,l.push({spuId:a.id,spuDetail:a,propertyList:me(a)}),h.value.push(a),k.value=l};R({open:async(o,e)=>{var t;if(p.value=!0,C.value=S("action."+o),w.value=o,await A(),e){d.value=!0;try{const l=await ie(e);await F(l.spuId,(t=l.products)==null?void 0:t.map(f=>f.skuId),l.products),m.value.setValues(l)}finally{d.value=!1}}}});const A=async()=>{h.value=[],k.value=[],await W(),m.value.getElFormRef().resetFields()},E=x,z=async()=>{if(m&&await m.value.getElFormRef().validate()){d.value=!0;try{const o=Y(D.value.getSkuConfigs("productConfig"));o.forEach(t=>{t.combinationPrice=X(t.combinationPrice)});const e=Y(m.value.formModel);e.products=o,w.value==="create"?(await le(e),_.success(S("common.createSuccess"))):(await re(e),_.success(S("common.updateSuccess"))),p.value=!1,E("success")}finally{d.value=!1}}};return(o,e)=>{const t=Z,l=$,f=ee,a=se,b=te,y=ae;return V(),K(Q,null,[n(b,{modelValue:i(p),"onUpdate:modelValue":e[2]||(e[2]=s=>J(p)?p.value=s:null),title:i(C),width:"65%"},{footer:u(()=>[n(t,{disabled:i(d),type:"primary",onClick:z},{default:u(()=>[P("\u786E \u5B9A")]),_:1},8,["disabled"]),n(t,{onClick:e[1]||(e[1]=s=>p.value=!1)},{default:u(()=>[P("\u53D6 \u6D88")]),_:1})]),default:u(()=>[j((V(),H(a,{ref_key:"formRef",ref:m,"is-col":!0,rules:i(de),schema:i(be).formSchema,class:"mt-10px"},{spuId:u(()=>[n(t,{onClick:e[0]||(e[0]=s=>i(I).open())},{default:u(()=>[P("\u9009\u62E9\u5546\u54C1")]),_:1}),n(i(ce),{ref_key:"spuAndSkuListRef",ref:D,"rule-config":L,"spu-list":i(h),"spu-property-list-p":i(k)},{default:u(()=>[n(f,{align:"center",label:"\u62FC\u56E2\u4EF7\u683C(\u5143)","min-width":"168"},{default:u(({row:s})=>[n(l,{modelValue:s.productConfig.combinationPrice,"onUpdate:modelValue":v=>s.productConfig.combinationPrice=v,min:0,precision:2,step:.1,class:"w-100%"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["spu-list","spu-property-list-p"])]),_:1},8,["rules","schema"])),[[y,i(d)]])]),_:1},8,["modelValue","title"]),n(i(ue),{ref_key:"spuSelectRef",ref:I,isSelectSku:!0,onConfirm:N},null,512)],64)}}});export{ve as _};
