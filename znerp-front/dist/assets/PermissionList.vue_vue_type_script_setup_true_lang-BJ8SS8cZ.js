import{d as F,r as n,dU as B,ar as R,o as c,c as D,q as f,w as v,a as t,f as i,x as _,a5 as w,y as H,D as K,L as V,F as G,z as J,H as Q,I as X,j as Y,K as Z,M as $}from"./index-CIfmhqRC.js";import{_ as ee}from"./DictTag.vue_vue_type_script_lang-CTpVFm77.js";import{d as ae}from"./formatTime-DFFN_xWx.js";import{g as le,P as y,d as se,a as ie}from"./index-8CYEcIk3.js";import{_ as te}from"./PermissionForm.vue_vue_type_script_setup_true_lang-BA269V0x.js";const re=F({name:"CrmPermissionList",__name:"PermissionList",props:{bizType:{},bizId:{},showAction:{type:Boolean}},emits:["quitTeam"],setup(x,{expose:U,emit:N}){const o=J(),u=x,h=n(!0),r=n([]),C=n({ownerUserId:0}),g=B(),k=async()=>{h.value=!0;try{const e=await le({bizType:u.bizType,bizId:u.bizId});r.value=e,r.value.find(a=>a.userId===g.getUser.id&&a.level===y.OWNER)&&(C.value.ownerUserId=g.getUser.id)}finally{h.value=!1}},d=n([]),T=n(),O=e=>{var a;if(e.findIndex(l=>l.level===y.OWNER)!==-1)return o.warning("\u4E0D\u80FD\u9009\u62E9\u8D1F\u8D23\u4EBA\uFF01"),void((a=T.value)==null?void 0:a.clearSelection());d.value=e},z=n(),W=()=>{var e,a,l;((e=d.value)==null?void 0:e.length)!==0?((a=d.value)==null?void 0:a.length)>1?o.warning("\u7F16\u8F91\u56E2\u961F\u6210\u5458\u65F6\u53EA\u80FD\u9009\u62E9\u4E00\u4E2A\uFF01"):(l=z.value)==null||l.open0("update",u.bizType,u.bizId,d.value[0].id,d.value[0].level):o.warning("\u8BF7\u5148\u9009\u62E9\u56E2\u961F\u6210\u5458\u540E\u64CD\u4F5C\uFF01")},L=async()=>{var a,l;if(((a=d.value)==null?void 0:a.length)===0)return void o.warning("\u8BF7\u5148\u9009\u62E9\u56E2\u961F\u6210\u5458\u540E\u64CD\u4F5C\uFF01");await o.delConfirm();const e=(l=d.value)==null?void 0:l.map(s=>s.id);await se(e),o.success("\u79FB\u9664\u56E2\u961F\u6210\u5458\u6210\u529F\uFF01"),await k()},E=()=>{var e;(e=z.value)==null||e.open("create",u.bizType,u.bizId)},p=n(!1),b=n(!1),I=n(!1);R(r,e=>{var a;if(I.value=!1,(e==null?void 0:e.length)>0){I.value=!r.value.some(s=>s.level===y.OWNER),p.value=!1,b.value=!1;const l=(a=g.getUser)==null?void 0:a.id;r.value.filter(s=>s.userId===l).forEach(s=>{s.level===y.OWNER?(p.value=!0,b.value=!0):s.level===y.WRITE&&(b.value=!0)})}else I.value=!0},{immediate:!0}),U({openForm:E,validateOwnerUser:p,validateWrite:b,isPool:I});const P=N,S=async()=>{if(r.value.find(a=>a.userId===g.getUser.id&&a.level===y.OWNER))return void o.warning("\u8D1F\u8D23\u4EBA\u4E0D\u80FD\u9000\u51FA\u56E2\u961F\uFF01");const e=r.value.find(a=>a.userId===g.getUser.id);e&&(await ie(e.id),o.success("\u9000\u51FA\u56E2\u961F\u6210\u5458\u6210\u529F\uFF01"),P("quitTeam"))};return R(()=>u.bizId,e=>{e&&k()},{immediate:!0,deep:!0}),(e,a)=>{const l=Q,s=X,q=Y,m=Z,M=ee,j=$;return c(),D(G,null,[e.showAction?(c(),f(q,{key:0,justify:"end"},{default:v(()=>[t(p)?(c(),f(s,{key:0,type:"primary",onClick:E},{default:v(()=>[i(l,{class:"mr-5px",icon:"ep:plus"}),_(" \u65B0\u589E ")]),_:1})):w("",!0),t(p)?(c(),f(s,{key:1,onClick:W},{default:v(()=>[i(l,{class:"mr-5px",icon:"ep:edit"}),_(" \u7F16\u8F91 ")]),_:1})):w("",!0),t(p)?(c(),f(s,{key:2,onClick:L},{default:v(()=>[i(l,{class:"mr-5px",icon:"ep:delete"}),_(" \u79FB\u9664 ")]),_:1})):w("",!0),!t(p)&&t(r).length>0?(c(),f(s,{key:3,type:"danger",onClick:S},{default:v(()=>[_(" \u9000\u51FA\u56E2\u961F ")]),_:1})):w("",!0)]),_:1})):w("",!0),H((c(),f(t(V),{ref_key:"elTableRef",ref:T,data:t(r),"show-overflow-tooltip":!0,stripe:!0,class:"mt-20px",onSelectionChange:O},{default:v(()=>[i(m,{type:"selection",width:"55"}),i(m,{align:"center",label:"\u59D3\u540D",prop:"nickname"}),i(m,{align:"center",label:"\u90E8\u95E8",prop:"deptName"}),i(m,{align:"center",label:"\u5C97\u4F4D",prop:"postNames"}),i(m,{align:"center",label:"\u6743\u9650\u7EA7\u522B",prop:"level"},{default:v(({row:A})=>[i(M,{type:t(K).CRM_PERMISSION_LEVEL,value:A.level},null,8,["type","value"])]),_:1}),i(m,{formatter:t(ae),align:"center",label:"\u52A0\u5165\u65F6\u95F4",prop:"createTime"},null,8,["formatter"])]),_:1},8,["data"])),[[j,t(h)]]),i(te,{ref_key:"formRef",ref:z,onSuccess:k},null,512)],64)}}});export{re as _};
