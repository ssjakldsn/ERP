import{bt as K,dw as ue,d as pe,ct as V,r as v,z as de,e as me,a3 as D,eA as fe,ay as G,bZ as ve,a as s,as as ye,O as he,o as n,q as b,w as f,f as i,g as y,t as W,c as A,F as ge,p as we,a5 as h,W as P,y as Y,a4 as Te,k as xe,x as ke,b7 as Me,b0 as _e,H as Ee,e2 as Ie,U as be,I as Ne,ea as Se,b5 as Re,a0 as Ae,a1 as Ue,aw as Ce,_ as De}from"./index-CIfmhqRC.js";import{E as He}from"./el-empty-fTn0RAmM.js";import{E as je}from"./el-image-DLpquQe6.js";import{E as Fe}from"./el-avatar-Cbg-oQZd.js";import{_ as Le}from"./EmojiSelectPopover.vue_vue_type_script_setup_true_lang-BeZqZpAK.js";import{_ as Be}from"./PictureSelectUpload.vue_vue_type_script_setup_true_lang-CCwYTsa9.js";import Oe from"./ProductItem-Cv4ArqnW.js";import ze from"./OrderItem-Bpiqn_Aj.js";import{u as Ke}from"./emoji-B3TTaVnW.js";import{K as g}from"./constants-CD8mqZTg.js";import{U as B}from"./constants-A8BI3pz7.js";import{f as Ve}from"./formatTime-DFFN_xWx.js";import"./picture-CTjip5lJ.js";const We=async o=>await K.post({url:"/promotion/kefu-message/send",data:o}),Xe=async o=>await K.put({url:"/promotion/kefu-message/update-read-status?conversationId="+o}),$e=async o=>await K.get({url:"/promotion/kefu-message/page",params:o});var Ge={exports:{}};const Pe=ue(Ge.exports=function(o,O,c){o=o||{};var w=O.prototype,H={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function p(r,l,d,_){return w.fromToBase(r,l,d,_)}c.en.relativeTime=H,w.fromToBase=function(r,l,d,_,T){for(var N,E,U,x=d.$locale().relativeTime||H,C=o.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],z=C.length,I=0;I<z;I+=1){var m=C[I];m.d&&(N=_?c(r).diff(d,m.d,!0):d.diff(r,m.d,!0));var k=(o.rounding||Math.round)(Math.abs(N));if(U=N>0,k<=m.r||!m.r){k<=1&&I>0&&(m=C[I-1]);var S=x[m.l];T&&(k=T(""+k)),E=typeof S=="string"?S.replace("%d",k):S(k,l,m.l,U);break}}if(l)return E;var M=U?x.future:x.past;return typeof M=="function"?M(E):M.replace("%s",E)},w.to=function(r,l){return p(r,l,this,!0)},w.from=function(r,l){return p(r,l,this)};var u=function(r){return r.$u?c.utc():c()};w.toNow=function(r){return this.to(u(this),r)},w.fromNow=function(r){return this.from(u(this),r)}}),Ye={class:"kefu-title"},qe={class:"flex justify-center items-center mb-20px"},Qe={key:0,class:"date-message"},Ze={key:1,class:"system-message"},Je={key:0,class:"flex items-center"},ea=(o=>(Ae("data-v-8197f77c"),o=o(),Ue(),o))(()=>y("span",null,"\u6709\u65B0\u6D88\u606F",-1)),aa={class:"h-[100%]"},sa={class:"chat-tools flex items-center"},ta={class:"h-45px flex justify-end"},ra=De(pe({name:"KeFuMessageList",__name:"KeFuMessageList",setup(o,{expose:O}){V.extend(Pe);const c=v(""),{replaceEmoji:w}=Ke(),H=de(),p=v([]),u=v({}),r=v(!1),l=me({pageNo:1,pageSize:10,conversationId:0}),d=v(0),_=v(!1),T=D(()=>e=>fe(e.content)),N=async()=>{const e=await $e(l);if(d.value=e.total,l.pageNo===1)p.value=e.list;else for(const t of e.list)E(t);_.value=!0},E=e=>{p.value.some(t=>t.id===e.id)||p.value.push(e)},U=D(()=>(p.value.sort((e,t)=>e.createTime-t.createTime),p.value)),x=async e=>{if(u.value){if(e!==void 0){if(e.conversationId!==u.value.id)return;E(e)}else l.pageNo=1,await N();R.value?r.value=!0:await X()}};O({getNewMessageList:async e=>{l.pageNo=1,p.value=[],d.value=0,R.value=!1,_.value=!1,u.value=e,l.conversationId=e.id,await x()},refreshMessageList:x});const C=D(()=>!G(u.value)),z=D(()=>d.value>0&&Math.ceil(d.value/l.pageSize)===l.pageNo),I=e=>{c.value+=e.name},m=async e=>{const t={conversationId:u.value.id,contentType:g.IMAGE,content:e};await S(t)},k=async()=>{if(G(s(c.value)))return void H.notifyWarning("\u8BF7\u8F93\u5165\u6D88\u606F\u540E\u518D\u53D1\u9001\u54E6\uFF01");const e={conversationId:u.value.id,contentType:g.TEXT,content:c.value};await S(e)},S=async e=>{await We(e),c.value="",await x()},M=v(),j=v(),X=async()=>{R.value=!1,await(async()=>{R.value||(await Ce(),j.value.setScrollTop(M.value.clientHeight),r.value=!1,await Xe(u.value.id))})()},R=v(!1),q=ve(({scrollTop:e})=>{var F;if(z.value)return;Math.floor(e)===0&&Q();const t=(F=j.value)==null?void 0:F.wrapRef;Math.abs(t.scrollHeight-t.clientHeight-t.scrollTop)<1&&(R.value=!1,x())},200),Q=async()=>{var t;const e=(t=M.value)==null?void 0:t.clientHeight;e&&(R.value=!0,l.pageNo+=1,await N(),j.value.setScrollTop(M.value.clientHeight-e))},Z=D(()=>(e,t)=>s(p.value)[t+1]?V(s(p.value)[t+1].createTime).fromNow()!==V(s(e).createTime).fromNow():!1);return(e,t)=>{const F=Me,$=Fe,L=ye("MessageItem"),J=je,ee=_e,ae=Ee,se=Ie,te=be,re=Ne,le=Se,oe=Re,ne=He,ie=he("dompurify-html");return s(C)?(n(),b(oe,{key:0,class:"kefu"},{default:f(()=>[i(F,null,{default:f(()=>[y("div",Ye,W(s(u).userNickname),1)]),_:1}),i(se,{class:"kefu-content overflow-visible"},{default:f(()=>[i(ee,{ref_key:"scrollbarRef",ref:j,always:"",height:"calc(100vh - 495px)",onScroll:s(q)},{default:f(()=>[s(_)?(n(),A("div",{key:0,ref_key:"innerRef",ref:M,class:"w-[100%] pb-3px"},[(n(!0),A(ge,null,we(s(U),(a,ce)=>(n(),A("div",{key:a.id,class:"w-[100%]"},[y("div",qe,[a.contentType!==s(g).SYSTEM&&s(Z)(a,ce)?(n(),A("div",Qe,W(s(Ve)(a.createTime)),1)):h("",!0),a.contentType===s(g).SYSTEM?(n(),A("div",Ze,W(a.content),1)):h("",!0)]),y("div",{class:P([[a.senderType===s(B).MEMBER?"ss-row-left":a.senderType===s(B).ADMIN?"ss-row-right":""],"flex mb-20px w-[100%]"])},[a.senderType===s(B).MEMBER?(n(),b($,{key:0,src:s(u).userAvatar,alt:"avatar",class:"w-60px h-60px"},null,8,["src"])):h("",!0),y("div",{class:P([{"kefu-message":s(g).TEXT===a.contentType},"p-10px"])},[i(L,{message:a},{default:f(()=>[s(g).TEXT===a.contentType?Y((n(),A("div",Je,null,512)),[[ie,s(w)(a.content)]]):h("",!0)]),_:2},1032,["message"]),i(L,{message:a},{default:f(()=>[s(g).IMAGE===a.contentType?(n(),b(J,{key:0,"initial-index":0,"preview-src-list":[a.content],src:a.content,class:"w-200px",fit:"contain","preview-teleported":""},null,8,["preview-src-list","src"])):h("",!0)]),_:2},1032,["message"]),i(L,{message:a},{default:f(()=>[s(g).PRODUCT===a.contentType?(n(),b(Oe,{key:0,spuId:s(T)(a).spuId,picUrl:s(T)(a).picUrl,price:s(T)(a).price,skuText:s(T)(a).introduction,title:s(T)(a).spuName,titleWidth:400,class:"max-w-70%",priceColor:"#FF3000"},null,8,["spuId","picUrl","price","skuText","title"])):h("",!0)]),_:2},1032,["message"]),i(L,{message:a},{default:f(()=>[s(g).ORDER===a.contentType?(n(),b(ze,{key:0,message:a,class:"max-w-100%"},null,8,["message"])):h("",!0)]),_:2},1032,["message"])],2),a.senderType===s(B).ADMIN?(n(),b($,{key:1,src:a.senderAvatar,alt:"avatar"},null,8,["src"])):h("",!0)],2)]))),128))],512)):h("",!0)]),_:1},8,["onScroll"]),Y(y("div",{class:"newMessageTip flex items-center cursor-pointer",onClick:X},[ea,i(ae,{class:"ml-5px",icon:"ep:bottom"})],512),[[Te,s(r)]])]),_:1}),i(le,{height:"230px"},{default:f(()=>[y("div",aa,[y("div",sa,[i(Le,{onSelectEmoji:I}),i(Be,{class:"ml-15px mt-3px cursor-pointer",onSendPicture:m})]),i(te,{modelValue:s(c),"onUpdate:modelValue":t[0]||(t[0]=a=>xe(c)?c.value=a:null),rows:6,style:{"border-style":"none"},type:"textarea"},null,8,["modelValue"]),y("div",ta,[i(re,{class:"mt-10px",type:"primary",onClick:k},{default:f(()=>[ke("\u53D1\u9001")]),_:1})])])]),_:1})]),_:1})):(n(),b(ne,{key:1,description:"\u8BF7\u9009\u62E9\u5DE6\u4FA7\u7684\u4E00\u4E2A\u4F1A\u8BDD\u540E\u5F00\u59CB"}))}}}),[["__scopeId","data-v-8197f77c"]]);export{ra as default};
