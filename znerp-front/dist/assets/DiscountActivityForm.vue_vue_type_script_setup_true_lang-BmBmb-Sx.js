import{e as x,bt as P,d as G,h as H,z as J,r as l,o as B,c as N,f as c,w as n,a as r,x as D,y as O,q as Q,k as W,F as X,aA as g,aB as Z,aw as $,I as ee,cc as te,K as ae,M as oe}from"./index-CIfmhqRC.js";import{_ as se}from"./Dialog.vue_vue_type_style_index_0_lang-CtaLqQeX.js";import{_ as ie}from"./Form-cSLPXDG2.js";import{_ as re}from"./SpuSelect.vue_vue_type_script_setup_true_lang-CJLQ12oD.js";import{_ as le}from"./SpuAndSkuList.vue_vue_type_script_setup_true_lang-DI30tUg0.js";import{b as M}from"./formatTime-DFFN_xWx.js";import{r as h}from"./formRules-C3y0LKNH.js";import{u as ce}from"./useCrudSchemas-BA8R3pf3.js";import{b as ue}from"./spu-BTu6kAbO.js";import{g as ne}from"./index-BRD6A8QB.js";const de=x({spuId:[h],name:[h],startTime:[h],endTime:[h],discountType:[h]}),pe=x([{label:"\u6D3B\u52A8\u540D\u79F0",field:"name",isSearch:!0,form:{colProps:{span:24}},table:{width:120}},{label:"\u6D3B\u52A8\u5F00\u59CB\u65F6\u95F4",field:"startTime",formatter:M,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u6D3B\u52A8\u7ED3\u675F\u65F6\u95F4",field:"endTime",formatter:M,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u6D3B\u52A8\u5546\u54C1",field:"spuId",isTable:!0,isSearch:!1,form:{colProps:{span:24}},table:{width:300}},{label:"\u5907\u6CE8",field:"remark",isSearch:!1,form:{component:"Input",componentProps:{type:"textarea",rows:4},colProps:{span:24}},table:{width:300}}]),{allSchemas:me}=ce(pe),fe=async m=>await P.get({url:"/promotion/discount-activity/page",params:m}),ve=async m=>await P.put({url:"/promotion/discount-activity/close?id="+m}),ye=async m=>await P.delete({url:"/promotion/discount-activity/delete?id="+m}),Pe=G({name:"PromotionDiscountActivityForm",__name:"DiscountActivityForm",emits:["success"],setup(m,{expose:R,emit:U}){const{t:I}=H(),_=J(),f=l(!1),V=l(""),v=l(!1),C=l(""),y=l(),F=l(),T=l(),A=[],S=l([]),w=l([]),k=l([]),E=(o,t)=>{Y(o,t)},Y=async(o,t,i,a)=>{var b;if(k.value.includes(o))return void(a!=="load"&&_.error("\u6570\u636E\u91CD\u590D\u9009\u62E9\uFF01"));k.value.push(o);const u=await ue([o]);if(u.length==0)return;const s=u[0],d=t===void 0?s==null?void 0:s.skus:(b=s==null?void 0:s.skus)==null?void 0:b.filter(e=>t.includes(e.id));d==null||d.forEach(e=>{let p={skuId:e.id,spuId:s.id,discountType:1,discountPercent:0,discountPrice:0};i!==void 0&&(p=i.find(K=>K.skuId===e.id)||p),e.productConfig=p,e.price=g(e.price),e.marketPrice=g(e.marketPrice),e.costPrice=g(e.costPrice),e.firstBrokeragePrice=g(e.firstBrokeragePrice),e.secondBrokeragePrice=g(e.secondBrokeragePrice)}),s.skus=d,w.value.push({spuId:s.id,spuDetail:s,propertyList:ne(s)}),S.value.push(s)};R({open:async(o,t)=>{var i;if(f.value=!0,V.value=I("action."+o),C.value=o,await q(),t){v.value=!0;try{const a=await(async u=>await P.get({url:"/promotion/discount-activity/get?id="+u}))(t);for(let u in a.products){const s=a.products[u].spuId;await Y(s,(i=a.products)==null?void 0:i.map(d=>d.skuId),a.products,"load")}y.value.setValues(a)}finally{v.value=!1}}}});const L=U,j=async()=>{if(y&&await y.value.getElFormRef().validate()){v.value=!0;try{const o=y.value.formModel,t=Z(T.value.getSkuConfigs("productConfig"));let i=!1;if(t.forEach(a=>{a.discountPrice!=null&&a.discountPrice>0?a.discountType=1:a.discountPercent!=null&&a.discountPercent>0?a.discountType=2:i=!0}),i)return void _.error("\u4F18\u60E0\u91D1\u989D\u548C\u6298\u6263\u767E\u5206\u6BD4\u9700\u8981\u586B\u5199\u4E00\u4E2A");o.products=t,C.value==="create"?(await(async a=>await P.post({url:"/promotion/discount-activity/create",data:a}))(o),_.success(I("common.createSuccess"))):(await(async a=>await P.put({url:"/promotion/discount-activity/update",data:a}))(o),_.success(I("common.updateSuccess"))),f.value=!1,L("success")}finally{v.value=!1}}},q=async()=>{S.value=[],w.value=[],k.value=[],await $(),y.value.getElFormRef().resetFields()},z=o=>{k.value.splice(k.value.findIndex(t=>t==o),1),w.value.splice(w.value.findIndex(t=>t.spuId==o),1)};return(o,t)=>{const i=ee,a=te,u=ae,s=ie,d=se,b=oe;return B(),N(X,null,[c(d,{modelValue:r(f),"onUpdate:modelValue":t[2]||(t[2]=e=>W(f)?f.value=e:null),title:r(V),width:"65%"},{footer:n(()=>[c(i,{disabled:r(v),type:"primary",onClick:j},{default:n(()=>[D("\u786E \u5B9A")]),_:1},8,["disabled"]),c(i,{onClick:t[1]||(t[1]=e=>f.value=!1)},{default:n(()=>[D("\u53D6 \u6D88")]),_:1})]),default:n(()=>[O((B(),Q(s,{ref_key:"formRef",ref:y,isCol:!0,rules:r(de),schema:r(me).formSchema},{spuId:n(()=>[c(i,{onClick:t[0]||(t[0]=e=>r(F).open())},{default:n(()=>[D("\u9009\u62E9\u5546\u54C1")]),_:1}),c(r(le),{ref_key:"spuAndSkuListRef",ref:T,"rule-config":A,"spu-list":r(S),"spu-property-list-p":r(w),isDelete:!0,onDelete:z},{default:n(()=>[c(u,{align:"center",label:"\u4F18\u60E0\u91D1\u989D","min-width":"168"},{default:n(({row:e})=>[c(a,{modelValue:e.productConfig.discountPrice,"onUpdate:modelValue":p=>e.productConfig.discountPrice=p,min:0,class:"w-100%"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),c(u,{align:"center",label:"\u6298\u6263\u767E\u5206\u6BD4(%)","min-width":"168"},{default:n(({row:e})=>[c(a,{modelValue:e.productConfig.discountPercent,"onUpdate:modelValue":p=>e.productConfig.discountPercent=p,class:"w-100%"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["spu-list","spu-property-list-p"])]),_:1},8,["rules","schema"])),[[b,r(v)]])]),_:1},8,["modelValue","title"]),c(r(re),{ref_key:"spuSelectRef",ref:F,isSelectSku:!0,onConfirm:E},null,512)],64)}}});export{Pe as _,ve as c,ye as d,fe as g};
