import{d as ee,r as n,e as le,ar as ae,a3 as z,o as i,q as c,w as a,f as e,x as A,a as d,y as de,c as V,p as I,F as g,k as B,dV as oe,h as te,z as ue,dW as re,b as se,U as ne,C as ie,E as me,A as ce,B as pe,j as fe,G as ve,l as be,m as _e,cc as Ve,J as Ie,I as ge,M as Ue}from"./index-CIfmhqRC.js";import{_ as we}from"./Dialog.vue_vue_type_style_index_0_lang-CtaLqQeX.js";import{_ as Pe}from"./ContentWrap.vue_vue_type_script_setup_true_lang-sm5dIhPQ.js";import{a as ye}from"./index-BZptzjxi.js";import{b as ke,c as he,u as Ce}from"./index-jPQDaA_X.js";import{g as Te}from"./index-QrlE36WK.js";import{b as xe}from"./index-B_QTmj5f.js";import{d as De,a as qe}from"./index-B5nlbV2q.js";import{_ as Fe}from"./ContractProductForm.vue_vue_type_script_setup_true_lang-BBuHPlBt.js";const Se=ee({__name:"ContractForm",emits:["success"],setup(ze,{expose:E,emit:G}){const{t:P}=te(),C=ue(),p=n(!1),T=n(""),f=n(!1),U=n(""),o=n({id:void 0,no:void 0,name:void 0,customerId:void 0,businessId:void 0,orderDate:void 0,startTime:void 0,endTime:void 0,signUserId:void 0,signContactId:void 0,ownerUserId:void 0,discountPercent:0,totalProductPrice:void 0,remark:void 0,products:[]}),J=le({name:[{required:!0,message:"\u5408\u540C\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A",trigger:"blur"}],customerId:[{required:!0,message:"\u5BA2\u6237\u4E0D\u80FD\u4E3A\u7A7A",trigger:"blur"}],orderDate:[{required:!0,message:"\u4E0B\u5355\u65E5\u671F\u4E0D\u80FD\u4E3A\u7A7A",trigger:"blur"}],ownerUserId:[{required:!0,message:"\u8D1F\u8D23\u4EBA\u4E0D\u80FD\u4E3A\u7A7A",trigger:"blur"}]}),w=n(),y=n([]),x=n([]),D=n([]),q=n([]),k=n("product"),F=n();ae(()=>o.value,u=>{if(!u)return;const t=u.products.reduce((r,s)=>r+s.totalPrice,0),m=t-(u.discountPercent!=null?re(t,u.discountPercent/100):0);o.value.totalProductPrice=t,o.value.totalPrice=m},{deep:!0}),E({open:async(u,t)=>{if(p.value=!0,T.value=P("action."+u),U.value=u,W(),t){f.value=!0;try{o.value=await ke(t)}finally{f.value=!1}}x.value=await ye(),y.value=await Te(),U.value==="create"&&(o.value.ownerUserId=se().getUser.id),q.value=await xe(),D.value=await De()}});const M=G,R=async()=>{if(w&&await w.value.validate()){f.value=!0,F.value.validate();try{const u=d(o.value);U.value==="create"?(await he(u),C.success(P("common.createSuccess"))):(await Ce(u),C.success(P("common.updateSuccess"))),p.value=!1,M("success")}finally{f.value=!1}}},W=()=>{var u;o.value={id:void 0,no:void 0,name:void 0,customerId:void 0,businessId:void 0,orderDate:void 0,startTime:void 0,endTime:void 0,signUserId:void 0,signContactId:void 0,ownerUserId:void 0,discountPercent:0,totalProductPrice:void 0,remark:void 0,products:[]},(u=w.value)==null||u.resetFields()},j=()=>{o.value.businessId=void 0,o.value.signContactId=void 0,o.value.products=[]},H=async u=>{const t=await qe(u);t.products.forEach(m=>{m.contractPrice=m.businessPrice}),o.value.products=t.products},K=z(()=>q.value.filter(u=>u.customerId==o.value.customerId)),N=z(()=>D.value.filter(u=>u.customerId==o.value.customerId));return(u,t)=>{const m=ne,r=ie,s=me,v=ce,b=pe,_=fe,h=ve,O=be,Q=_e,X=Pe,Y=Ve,Z=Ie,S=ge,$=we,L=Ue;return i(),c($,{modelValue:d(p),"onUpdate:modelValue":t[16]||(t[16]=l=>B(p)?p.value=l:null),title:d(T),width:"1280"},{footer:a(()=>[e(S,{disabled:d(f),type:"primary",onClick:R},{default:a(()=>[A("\u4FDD\u5B58")]),_:1},8,["disabled"]),e(S,{onClick:t[15]||(t[15]=l=>p.value=!1)},{default:a(()=>[A("\u53D6 \u6D88")]),_:1})]),default:a(()=>[de((i(),c(Z,{ref_key:"formRef",ref:w,model:d(o),rules:d(J),"label-width":"120px"},{default:a(()=>[e(_,null,{default:a(()=>[e(s,{span:8},{default:a(()=>[e(r,{label:"\u5408\u540C\u7F16\u53F7",prop:"no"},{default:a(()=>[e(m,{disabled:"",modelValue:d(o).no,"onUpdate:modelValue":t[0]||(t[0]=l=>d(o).no=l),placeholder:"\u4FDD\u5B58\u65F6\u81EA\u52A8\u751F\u6210"},null,8,["modelValue"])]),_:1})]),_:1}),e(s,{span:8},{default:a(()=>[e(r,{label:"\u5408\u540C\u540D\u79F0",prop:"name"},{default:a(()=>[e(m,{modelValue:d(o).name,"onUpdate:modelValue":t[1]||(t[1]=l=>d(o).name=l),placeholder:"\u8BF7\u8F93\u5165\u5408\u540C\u540D\u79F0"},null,8,["modelValue"])]),_:1})]),_:1}),e(s,{span:8},{default:a(()=>[e(r,{label:"\u8D1F\u8D23\u4EBA",prop:"ownerUserId"},{default:a(()=>[e(b,{modelValue:d(o).ownerUserId,"onUpdate:modelValue":t[2]||(t[2]=l=>d(o).ownerUserId=l),disabled:d(U)!=="create",class:"w-1/1"},{default:a(()=>[(i(!0),V(g,null,I(d(y),l=>(i(),c(v,{key:l.id,label:l.nickname,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),e(_,null,{default:a(()=>[e(s,{span:8},{default:a(()=>[e(r,{label:"\u5BA2\u6237\u540D\u79F0",prop:"customerId"},{default:a(()=>[e(b,{modelValue:d(o).customerId,"onUpdate:modelValue":t[3]||(t[3]=l=>d(o).customerId=l),placeholder:"\u8BF7\u9009\u62E9\u5BA2\u6237",class:"w-1/1",onChange:j},{default:a(()=>[(i(!0),V(g,null,I(d(x),l=>(i(),c(v,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(s,{span:8},{default:a(()=>[e(r,{label:"\u5546\u673A\u540D\u79F0",prop:"businessId"},{default:a(()=>[e(b,{onChange:H,disabled:!d(o).customerId,modelValue:d(o).businessId,"onUpdate:modelValue":t[4]||(t[4]=l=>d(o).businessId=l),class:"w-1/1"},{default:a(()=>[(i(!0),V(g,null,I(d(N),l=>(i(),c(v,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["disabled","modelValue"])]),_:1})]),_:1})]),_:1}),e(_,null,{default:a(()=>[e(s,{span:8},{default:a(()=>[e(r,{label:"\u4E0B\u5355\u65E5\u671F",prop:"orderDate"},{default:a(()=>[e(h,{modelValue:d(o).orderDate,"onUpdate:modelValue":t[5]||(t[5]=l=>d(o).orderDate=l),placeholder:"\u9009\u62E9\u4E0B\u5355\u65E5\u671F",type:"date","value-format":"x",class:"!w-1/1"},null,8,["modelValue"])]),_:1})]),_:1}),e(s,{span:8},{default:a(()=>[e(r,{label:"\u5F00\u59CB\u65F6\u95F4",prop:"startTime"},{default:a(()=>[e(h,{modelValue:d(o).startTime,"onUpdate:modelValue":t[6]||(t[6]=l=>d(o).startTime=l),placeholder:"\u9009\u62E9\u5F00\u59CB\u65F6\u95F4",type:"date","value-format":"x",class:"!w-1/1"},null,8,["modelValue"])]),_:1})]),_:1}),e(s,{span:8},{default:a(()=>[e(r,{label:"\u7ED3\u675F\u65F6\u95F4",prop:"endTime"},{default:a(()=>[e(h,{modelValue:d(o).endTime,"onUpdate:modelValue":t[7]||(t[7]=l=>d(o).endTime=l),placeholder:"\u9009\u62E9\u7ED3\u675F\u65F6\u95F4",type:"date","value-format":"x",class:"!w-1/1"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(_,null,{default:a(()=>[e(s,{span:8},{default:a(()=>[e(r,{label:"\u516C\u53F8\u7B7E\u7EA6\u4EBA",prop:"signUserId"},{default:a(()=>[e(b,{modelValue:d(o).signUserId,"onUpdate:modelValue":t[8]||(t[8]=l=>d(o).signUserId=l),class:"w-1/1"},{default:a(()=>[(i(!0),V(g,null,I(d(y),l=>(i(),c(v,{key:l.id,label:l.nickname,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(s,{span:8},{default:a(()=>[e(r,{label:"\u5BA2\u6237\u7B7E\u7EA6\u4EBA",prop:"signContactId"},{default:a(()=>[e(b,{modelValue:d(o).signContactId,"onUpdate:modelValue":t[9]||(t[9]=l=>d(o).signContactId=l),disabled:!d(o).customerId,class:"w-1/1"},{default:a(()=>[(i(!0),V(g,null,I(d(K),l=>(i(),c(v,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1}),e(s,{span:8},{default:a(()=>[e(r,{label:"\u5907\u6CE8",prop:"remark"},{default:a(()=>[e(m,{modelValue:d(o).remark,"onUpdate:modelValue":t[10]||(t[10]=l=>d(o).remark=l),placeholder:"\u8BF7\u8F93\u5165\u5907\u6CE8",type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(X,null,{default:a(()=>[e(Q,{modelValue:d(k),"onUpdate:modelValue":t[11]||(t[11]=l=>B(k)?k.value=l:null),class:"-mt-15px -mb-10px"},{default:a(()=>[e(O,{label:"\u4EA7\u54C1\u6E05\u5355",name:"product"},{default:a(()=>[e(Fe,{ref_key:"productFormRef",ref:F,products:d(o).products,disabled:u.disabled},null,8,["products","disabled"])]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(_,null,{default:a(()=>[e(s,{span:8},{default:a(()=>[e(r,{label:"\u4EA7\u54C1\u603B\u91D1\u989D",prop:"totalProductPrice"},{default:a(()=>[e(m,{disabled:"",modelValue:d(o).totalProductPrice,"onUpdate:modelValue":t[12]||(t[12]=l=>d(o).totalProductPrice=l),formatter:d(oe)},null,8,["modelValue","formatter"])]),_:1})]),_:1}),e(s,{span:8},{default:a(()=>[e(r,{label:"\u6574\u5355\u6298\u6263\uFF08%\uFF09",prop:"discountPercent"},{default:a(()=>[e(Y,{modelValue:d(o).discountPercent,"onUpdate:modelValue":t[13]||(t[13]=l=>d(o).discountPercent=l),placeholder:"\u8BF7\u8F93\u5165\u6574\u5355\u6298\u6263","controls-position":"right",min:0,precision:2,class:"!w-1/1"},null,8,["modelValue"])]),_:1})]),_:1}),e(s,{span:8},{default:a(()=>[e(r,{label:"\u6298\u6263\u540E\u91D1\u989D",prop:"totalPrice"},{default:a(()=>[e(m,{disabled:"",modelValue:d(o).totalPrice,"onUpdate:modelValue":t[14]||(t[14]=l=>d(o).totalPrice=l),placeholder:"\u8BF7\u8F93\u5165\u5546\u673A\u91D1\u989D",formatter:u.erpPriceTableColumnFormattere},null,8,["modelValue","formatter"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","rules"])),[[L,d(f)]])]),_:1},8,["modelValue","title"])}}});export{Se as _};
